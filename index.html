<script>
  let html5QrCode;
  let isScanning = false;
  let validationCount = 0; // NOVO: Contador de validações

  function startScanner() {
    if (isScanning) return;

    const reader = document.getElementById('reader');
    reader.style.display = 'block';
    document.getElementById('successModal').style.display = 'none';

    html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
      { facingMode: "environment" },
      {
        fps: 30,
        qrbox: { width: window.innerWidth * 0.8, height: window.innerHeight * 0.8 },
        aspectRatio: 1.0,
        disableFlip: false,
        videoConstraints: {
          facingMode: "environment",
          width: { ideal: 1280 },
          height: { ideal: 720 }
        }
      },
      (decodedText, decodedResult) => {
        console.log(`Código lido: ${decodedText}`);
        html5QrCode.stop().then(() => {
          reader.style.display = 'none';
          isScanning = false;
          validationCount++; // AUMENTA o contador a cada escaneamento
          openModal(); // Abre o modal com sucesso
        }).catch((err) => {
          console.error("Erro ao parar scanner", err);
          isScanning = false;
        });
      },
      (errorMessage) => {
        console.warn(`Erro de leitura: ${errorMessage}`);
      }
    ).then(() => {
      isScanning = true;
    }).catch(err => {
      console.error("Erro ao iniciar câmera", err);
      reader.style.display = 'none';
      isScanning = false;
    });
  }

  function openModal() {
    const modal = document.getElementById('successModal');
    const validationText = modal.querySelector('p:nth-of-type(2)');
    const title = modal.querySelector('h2');

    validationText.innerText = `Validado: ${validationCount} vez${validationCount > 1 ? 'es' : ''}.`;

    // Se for mais de 1 validação, mudar a cor do título para amarelo
    if (validationCount > 1) {
      title.style.color = 'gold';
    } else {
      title.style.color = 'green'; // primeira vez, verde
    }

    modal.style.display = 'flex';
  }

  function closeModal() {
    document.getElementById('successModal').style.display = 'none';
  }
</script>
